# Быстрый старт: Внутренние объекты

## Что было реализовано

Система внутренних (виртуальных) объектов для учёта расходов и доходов по «HolyCowPhuket внутренний объект» в целом. Объект «HolyCowPhuket внутренний объект» и его филиалы не удаляются при синхронизации с Beds24.

## Архитектура решения

### 1. Новая коллекция `internalObjects`
- Отдельная коллекция MongoDB для хранения внутренних объектов
- Формат данных совместим с коллекцией `objects` из Beds24
- Использует отрицательные ID: `-1` (HolyCowPhuket внутренний объект), `-2`, `-3`, ... (филиалы)

### 2. Модифицированные файлы

#### Серверная логика:
- **`src/lib/server/internalObjects.ts`** (новый) — управление внутренними объектами
- **`src/lib/server/getObjects.ts`** — объединение объектов из обеих коллекций

#### API endpoints:
- **`src/app/api/internalObjects/init/route.ts`** (новый) — инициализация объекта "HolyCowPhuket внутренний объект"
- **`src/app/api/internalObjects/branches/route.ts`** (новый) — управление филиалами
- **`src/app/api/objects/route.ts`** — поддержка внутренних ID
- **`src/app/api/analytics/route.ts`** — поддержка внутренних ID
- **`src/app/api/bysuness/route.ts`** — поддержка внутренних ID

#### UI:
- **`src/app/dashboard/internalObjects/page.tsx`** (новый) — страница управления
- **`src/components/leftMenu/MiniDrawer.tsx`** — добавлен пункт меню
- **`src/i18n/translations/ru.json`** — русские переводы
- **`src/i18n/translations/en.json`** — английские переводы

#### Документация:
- **`INTERNAL_OBJECTS.md`** — полная документация
- **`INTERNAL_OBJECTS_QUICK_START.md`** — этот файл

## Первый запуск

### Шаг 1: Инициализация объекта "HolyCowPhuket внутренний объект"

После развёртывания изменений администратор должен инициализировать объект "HolyCowPhuket внутренний объект":

#### Вариант A: Через UI (рекомендуется)
1. Войти под учётной записью с ролью `admin`
2. Перейти в меню **"Внутренние объекты"** (Internal Objects)
3. Нажать кнопку **"Инициализировать объект «HolyCowPhuket внутренний объект»"**
4. Объект будет создан с одним филиалом "Главный офис"

#### Вариант B: Через API
```bash
curl -X POST http://your-domain/api/internalObjects/init \
  -H "Cookie: your-auth-cookie"
```

### Шаг 2: Добавление филиалов (опционально)

После инициализации можно добавить дополнительные филиалы:

1. На странице **"Внутренние объекты"**
2. Нажать кнопку **"Добавить филиал"**
3. Ввести название филиала (например, "Филиал в Москве")
4. Сохранить

Каждый новый филиал получит уникальный отрицательный ID: `-3`, `-4`, и т.д.

### Шаг 3: Использование в учёте

Теперь при создании расхода или дохода объект "HolyCowPhuket внутренний объект" будет доступен в списке объектов:

1. Перейти в **Бухгалтерия** → **Расходы** (или **Доходы**)
2. Нажать **"Добавить расход"** (или **"Добавить приход"**)
3. В поле **"Объект"** выбрать **"HolyCowPhuket внутренний объект"** (будет в начале списка)
4. Заполнить остальные поля и сохранить

## Проверка работы

### 1. Проверить создание объекта "HolyCowPhuket внутренний объект"

```javascript
// В MongoDB
db.internalObjects.find({})

// Ожидаемый результат:
{
  _id: ObjectId("..."),
  id: -1,
  name: "HolyCowPhuket внутренний объект",
  type: "company",
  roomTypes: [
    {
      units: [
        {
          id: -2,
          name: "Главный офис"
        }
      ]
    }
  ]
}
```

### 2. Проверить объединение объектов

```bash
# Запросить все объекты через API
curl http://your-domain/api/objects

# Объект "HolyCowPhuket внутренний объект" должен быть в начале списка
```

### 3. Проверить создание расхода для HolyCowPhuket внутренний объект

```bash
curl -X POST http://your-domain/api/expenses \
  -H "Content-Type: application/json" \
  -H "Cookie: your-auth-cookie" \
  -d '{
    "expense": {
      "objectId": -1,
      "category": "Административные расходы",
      "amount": 50000,
      "date": "2026-02-06",
      "status": "confirmed"
    }
  }'
```

### 4. Проверить синхронизацию с Beds24

```bash
# Запустить синхронизацию объектов
curl http://your-domain/api/sync?type=objects

# После синхронизации проверить, что объект "HolyCowPhuket внутренний объект" всё ещё существует
db.internalObjects.find({ id: -1 })
```

## Типичные сценарии использования

### Сценарий 1: Общие расходы компании

Расходы, которые не привязаны к конкретному объекту Beds24:
- Реклама и маркетинг
- Зарплата административного персонала
- Аренда офиса
- Коммунальные услуги офиса
- Программное обеспечение
- Бухгалтерские услуги

**Как учитывать**: создать расход с `objectId: -1` (HolyCowPhuket внутренний объект)

### Сценарий 2: Доходы по филиалам

Если компания имеет несколько филиалов, можно вести учёт по каждому:

**Настройка**:
1. Добавить филиалы: "Филиал в Москве" (ID `-3`), "Филиал в СПб" (ID `-4`)
2. При создании дохода указывать в комментарии филиал

**Альтернатива**: использовать привязку пользователей к филиалам через `UserObject`

### Сценарий 3: Отчёты по компании

Создание ежемесячных отчётов по компании в целом:

1. Перейти в **Бухгалтерия** → страница отчётов
2. Создать отчёт для объекта "HolyCowPhuket внутренний объект"
3. Указать месяц, год и ссылку на отчёт

## Настройка (опционально)

### Изменить название компании

По умолчанию объект называется "HolyCowPhuket внутренний объект". Чтобы изменить:

**Вариант 1**: Через переменную окружения (до инициализации)
```env
COMPANY_NAME=HolyCowPhuket внутренний объект
```

**Вариант 2**: Напрямую в базе (после инициализации)
```javascript
db.internalObjects.updateOne(
  { id: -1 },
  { $set: { name: "Новое название" } }
)
```

### Удалить объект "HolyCowPhuket внутренний объект" (для переинициализации)

⚠️ **Внимание**: это удалит объект, но расходы и доходы с `objectId: -1` останутся в системе.

```javascript
db.internalObjects.deleteOne({ id: -1 })
```

После этого можно заново вызвать инициализацию.

## Права доступа

### Для администраторов (`admin`)
- ✅ Инициализация объекта "HolyCowPhuket внутренний объект"
- ✅ Добавление/удаление/переименование филиалов
- ✅ Создание расходов/доходов для компании
- ✅ Просмотр всех данных

### Для бухгалтеров (`accountant`)
- ✅ Создание расходов/доходов для компании
- ✅ Просмотр расходов/доходов
- ❌ Управление филиалами

### Для владельцев (`owner`)
- ✅ Просмотр объекта "HolyCowPhuket внутренний объект" (если привязан через `UserObject`)
- ✅ Просмотр отчётов
- ❌ Создание расходов/доходов
- ❌ Управление филиалами

## Миграция данных

Если в системе уже есть расходы/доходы, привязанные к объектам Beds24, **миграция не требуется**. Внутренние объекты — это дополнительная функциональность.

Однако, если нужно переместить существующие записи на объект "HolyCowPhuket внутренний объект":

```javascript
// Пример: переместить все расходы категории "Административные расходы"
db.expenses.updateMany(
  { category: "Административные расходы" },
  { $set: { objectId: -1 } }
)
```

## Резервное копирование

При создании бэкапов базы данных убедитесь, что включена коллекция `internalObjects`:

```bash
mongodump --db=your_database --collection=internalObjects --out=/backup/path
```

## Устранение неполадок

### Проблема: Объект "HolyCowPhuket внутренний объект" не отображается в списке

**Решение**:
1. Проверить, выполнена ли инициализация:
   ```javascript
   db.internalObjects.find({ id: -1 })
   ```
2. Если объект есть, проверить, что `getObjects()` вызывается корректно
3. Очистить кэш браузера и перезагрузить страницу

### Проблема: Ошибка при создании расхода с `objectId: -1`

**Решение**:
1. Проверить, что объект "HolyCowPhuket внутренний объект" существует в `internalObjects`
2. Убедиться, что `objectId` передаётся как число, а не строка
3. Проверить права доступа пользователя

### Проблема: Объект "HolyCowPhuket внутренний объект" удалился после синхронизации

**Причина**: Неправильная модификация файла `sync/route.ts`

**Решение**: Убедиться, что в `sync/route.ts` очищается только коллекция `objects`, а не `internalObjects`

## Дальнейшее развитие

Потенциальные улучшения:

1. **Автоматическая инициализация** — при первом входе администратора
2. **UI для управления компанией** — переименование компании через интерфейс
3. **Множественные компании** — поддержка нескольких организаций
4. **Иерархия филиалов** — древовидная структура (головной офис → региональные филиалы → точки)
5. **Импорт/экспорт филиалов** — массовое управление через CSV

## Контакты и поддержка

При возникновении вопросов или проблем:
1. Изучите полную документацию в `INTERNAL_OBJECTS.md`
2. Проверьте логи сервера и браузера
3. Убедитесь, что все файлы обновлены корректно

---

**Версия**: 1.0  
**Дата**: 06.02.2026  
**Совместимость**: MongoDB 4.0+, Next.js 13+
