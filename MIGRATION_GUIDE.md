# Руководство по миграции бэкенда на Next.js

## Обзор изменений

Вся серверная логика из Express.js (папка `backend`) была успешно перенесена на Next.js API Routes (папка `frontend/src/app/api`).

## Что было сделано

### 1. Обновлены зависимости
В `frontend/package.json` добавлены необходимые зависимости:
- `bcrypt` - для хеширования паролей
- `jsonwebtoken` - для работы с JWT токенами
- `mongodb` - драйвер MongoDB
- `p-map` - для обработки массивов асинхронно

### 2. Перенесена структура базы данных
Созданы файлы для работы с MongoDB:
- `frontend/src/lib/db/connect.ts` - подключение к БД с connection pooling
- `frontend/src/lib/db/getDB.ts` - получение экземпляра БД
- `frontend/src/types/global.d.ts` - глобальные типы

### 3. Перенесены библиотеки и утилиты
- `frontend/src/lib/beds24/Beds24Connect.ts` - класс для работы с API Beds24
- `frontend/src/lib/utils/batches.ts` - утилиты для пакетной обработки
- `frontend/src/lib/server/getObjects.ts` - серверные функции для работы с объектами

### 4. Созданы API Routes
Все маршруты Express.js перенесены в Next.js API Routes:

#### Маршруты пользователей:
- `GET /api/users` - получение списка пользователей
- `GET /api/users?id={id}` - получение пользователя по ID
- `POST /api/users/addUser` - добавление пользователя
- `POST /api/users/editUser` - редактирование пользователя
- `DELETE /api/users/deleteUser?id={id}` - удаление пользователя

#### Авторизация:
- `POST /api/login` - авторизация пользователя

#### Объекты:
- `GET /api/objects` - получение списка объектов
- `GET /api/objects?all=true` - получение всех объектов
- `GET /api/objects?userID={id}` - получение объектов пользователя
- `GET /api/objects?id[]={ids}` - получение объектов по ID

#### Синхронизация:
- `GET /api/sync?type=objects` - синхронизация объектов
- `GET /api/sync?type=prices` - синхронизация цен
- `GET /api/sync?type=bookings` - синхронизация бронирований

#### Аналитика:
- `GET /api/analytics` - получение аналитики с параметрами:
  - `objects[]` - массив ID объектов
  - `startMedian` - начальная медиана
  - `endMedian` - конечная медиана
  - `startDate` - начальная дата
  - `endDate` - конечная дата
  - `periodMode` - режим периодов (beds24/custom)
  - `step` - шаг

#### Настройки:
- `GET /api/options` - получение настроек
- `POST /api/options` - сохранение настроек

#### Бронирования:
- `GET /api/bookings` - получение бронирований
- `GET /api/bysuness` - получение загруженности по дням

#### Отладка:
- `GET /api/debug` - тестовый маршрут для отладки

### 5. Обновлен клиентский код
Все файлы во `frontend/src/lib` обновлены для использования новых API Routes:
- Создана утилита `api-client.ts` для формирования URL API
- Удалена зависимость от `NEXT_PUBLIC_API_URL`
- Все запросы теперь идут на `/api/*` вместо внешнего сервера

## Установка и запуск

### 1. Установите зависимости
```bash
cd frontend
npm install
```

### 2. Настройте переменные окружения
Создайте файл `frontend/.env.local` со следующими переменными:

```env
# Database Configuration
DATABASE_LOGIN=your_database_login
DATABASE_PASS=your_database_password
DATABASE_URL=localhost
DATABASE_PORT=27017

# NextAuth Configuration
SECRET_KEY=your_secret_key_for_jwt_tokens
NEXTAUTH_SECRET=your_nextauth_secret
NEXTAUTH_URL=http://localhost:3000
```

### 3. Запустите приложение
```bash
npm run dev
```

Приложение запустится на `http://localhost:3000`

## Важные изменения

### Подключение к базе данных
Подключение к MongoDB теперь происходит автоматически при первом обращении к API. Используется connection pooling для оптимальной производительности.

### Асинхронная синхронизация
Маршрут `/api/sync` запускает синхронизацию асинхронно и сразу возвращает ответ. Процесс синхронизации продолжается в фоне.

### CORS
CORS больше не нужен, так как API и фронтенд теперь работают на одном домене.

## Удаление старого бэкенда

После успешной миграции и тестирования можно:
1. Остановить Express.js сервер
2. Удалить папку `backend` (рекомендуется сначала создать резервную копию)
3. Удалить переменную окружения `NEXT_PUBLIC_API_URL` из всех конфигурационных файлов

## Проверка работоспособности

После запуска проверьте:
1. ✅ Авторизация работает
2. ✅ Список объектов загружается
3. ✅ Аналитика рассчитывается
4. ✅ Синхронизация с Beds24 работает
5. ✅ Управление пользователями функционирует
6. ✅ Календарь загруженности отображается

## Troubleshooting

### Ошибка подключения к БД
Проверьте:
- Правильность credentials в `.env.local`
- Запущен ли MongoDB сервер
- Доступен ли MongoDB по указанному адресу

### Ошибка "SECRET_KEY не определен"
Убедитесь, что в `.env.local` указан `SECRET_KEY`

### Ошибки TypeScript
Выполните:
```bash
npm run build
```
Это покажет все ошибки типизации

## Производительность

Next.js API Routes предоставляют:
- ✅ Автоматическую оптимизацию кода
- ✅ Встроенный кэш
- ✅ Серверный рендеринг
- ✅ Меньший latency (API и фронтенд на одном сервере)

## Дальнейшие улучшения

Рекомендуется:
1. Добавить middleware для проверки авторизации
2. Реализовать rate limiting для API
3. Добавить логирование запросов
4. Настроить мониторинг производительности
5. Добавить unit-тесты для API Routes

