# Внутренние объекты (Internal Objects)

## Описание

Система внутренних объектов позволяет создавать виртуальные объекты, которые не синхронизируются с Beds24 и не удаляются при синхронизации. Основное применение — учёт расходов и доходов по «HolyCowPhuket внутренний объект» в целом.

## Архитектура

### Коллекция `internalObjects`

Внутренние объекты хранятся в отдельной коллекции MongoDB `internalObjects`, которая имеет ту же структуру, что и коллекция `objects` из Beds24:

```typescript
{
  id: number,           // Отрицательный ID (например, -1, -2, -3, ...)
  name: string,         // Название объекта
  type: 'company',      // Тип внутреннего объекта (для идентификации)
  roomTypes: [
    {
      units: [
        {
          id: number,   // Отрицательный ID филиала
          name: string  // Название филиала
        }
      ]
    }
  ]
}
```

### Диапазон ID

**Внутренние объекты используют отрицательные ID**, чтобы не пересекаться с положительными ID из Beds24:

- `-1` — объект "HolyCowPhuket внутренний объект"
- `-2`, `-3`, `-4`, ... — филиалы компании (комнаты)

Beds24 всегда использует положительные ID, поэтому конфликты исключены.

## Инициализация

### Первый запуск

При первом запуске системы нужно инициализировать объект "HolyCowPhuket внутренний объект":

1. **Через API (рекомендуется для администратора)**:
   ```bash
   POST /api/internalObjects/init
   ```
   Требуется авторизация с ролью `admin`.

2. **Программно**:
   ```typescript
   import { initializeInternalObjects } from '@/lib/server/internalObjects';
   await initializeInternalObjects();
   ```

### Что создаётся

При инициализации создаётся объект "HolyCowPhuket внутренний объект" с одним филиалом по умолчанию:

- **Объект**: ID `-1`, название "HolyCowPhuket внутренний объект" (или из `process.env.COMPANY_NAME`)
- **Филиал**: ID `-2`, название "Главный офис"

### Идемпотентность

Функция инициализации идемпотентна — можно вызывать многократно, дубликаты не создаются. Если объект "HolyCowPhuket внутренний объект" уже существует, инициализация пропускается.

## Использование

### Чтение объектов

Функции `getObjects()` и `getAllObjects()` автоматически объединяют объекты из обеих коллекций:

```typescript
import { getObjects } from '@/lib/server/getObjects';

const objects = await getObjects();
// Вернёт: [внутренние объекты, объекты из Beds24]
```

### Создание расходов/доходов для HolyCowPhuket внутренний объект

При создании расхода или дохода можно указать `objectId: -1` (или другой отрицательный ID):

```typescript
const expense = {
  objectId: -1,  // HolyCowPhuket внутренний объект
  category: "Административные расходы",
  amount: 50000,
  date: new Date(),
  status: "confirmed"
};
```

### Управление филиалами

#### Добавление филиала

```bash
POST /api/internalObjects/branches
{
  "branchName": "Филиал в Москве"
}
```

Вернёт:
```json
{
  "success": true,
  "message": "Филиал успешно добавлен",
  "branchId": -3
}
```

#### Переименование филиала

```bash
PUT /api/internalObjects/branches
{
  "branchId": -3,
  "newName": "Филиал в Санкт-Петербурге"
}
```

#### Удаление филиала

```bash
DELETE /api/internalObjects/branches
{
  "branchId": -3
}
```

**⚠️ Важно**: Все операции управления филиалами доступны только пользователям с ролью `admin`.

## Синхронизация с Beds24

### Что происходит при синхронизации

При синхронизации с Beds24 (`POST /api/sync?type=objects`):

1. ✅ Коллекция `objects` полностью очищается и заполняется данными из Beds24
2. ✅ Коллекция `internalObjects` **не затрагивается** — все внутренние объекты сохраняются

### Порядок объектов

При чтении списка объектов они возвращаются в следующем порядке:

1. Сначала внутренние объекты (из `internalObjects`)
2. Затем объекты из Beds24 (из `objects`)

Это позволяет объекту "HolyCowPhuket внутренний объект" всегда быть в начале списка.

## Права доступа

### Просмотр и использование

Все авторизованные пользователи могут:
- Видеть объект "HolyCowPhuket внутренний объект" в списках
- Создавать расходы/доходы для Компании
- Просматривать отчёты по Компании

### Управление

Только пользователи с ролью `admin` могут:
- Инициализировать внутренние объекты
- Добавлять новые филиалы
- Переименовывать филиалы
- Удалять филиалы

### Привязка пользователей к объектам

Пользователи могут быть привязаны к объекту "HolyCowPhuket внутренний объект" через стандартный механизм `UserObject`:

```typescript
{
  id: -1,        // ID объекта "HolyCowPhuket внутренний объект"
  rooms: [-2]    // ID филиалов, к которым есть доступ
}
```

## Отчёты и аналитика

Объект "HolyCowPhuket внутренний объект" участвует во всех отчётах и аналитике наравне с объектами из Beds24:

- ✅ Фильтрация по объектам
- ✅ Группировка по объектам
- ✅ Расчёт расходов/доходов
- ✅ Аудит логов

**Примечание**: Для объекта "HolyCowPhuket внутренний объект" не будет бронирований из Beds24, так как это виртуальный объект. Аналитика загруженности будет возвращать пустые данные.

## API Reference

### GET /api/objects

Возвращает список всех объектов (внутренние + Beds24).

**Параметры**:
- `all=true` — все объекты без фильтрации
- `id[]=1&id[]=2` — объекты с указанными ID (поддерживает отрицательные ID)
- `userID=xxx` — объекты, доступные конкретному пользователю

### POST /api/internalObjects/init

Инициализирует объект "HolyCowPhuket внутренний объект" (идемпотентно).

**Доступ**: только `admin`

**Ответ**:
```json
{
  "success": true,
  "message": "Объект \"HolyCowPhuket внутренний объект\" успешно инициализирован"
}
```

### POST /api/internalObjects/branches

Добавляет новый филиал к объекту "HolyCowPhuket внутренний объект".

**Доступ**: только `admin`

**Тело запроса**:
```json
{
  "branchName": "Название филиала"
}
```

### PUT /api/internalObjects/branches

Переименовывает существующий филиал.

**Доступ**: только `admin`

**Тело запроса**:
```json
{
  "branchId": -3,
  "newName": "Новое название"
}
```

### DELETE /api/internalObjects/branches

Удаляет филиал.

**Доступ**: только `admin`

**Тело запроса**:
```json
{
  "branchId": -3
}
```

## Примеры использования

### Пример 1: Учёт общих расходов компании

```typescript
// Создание расхода для компании в целом
const expense = {
  objectId: -1,  // HolyCowPhuket внутренний объект
  category: "Реклама и маркетинг",
  amount: 100000,
  date: new Date('2026-01-15'),
  status: "confirmed",
  comment: "Контекстная реклама в Яндекс.Директ"
};

await fetch('/api/expenses', {
  method: 'POST',
  body: JSON.stringify({ expense })
});
```

### Пример 2: Учёт дохода по конкретному филиалу

Хотя доходы привязываются к объекту, можно использовать поле `comment` для указания филиала:

```typescript
const income = {
  objectId: -1,  // HolyCowPhuket внутренний объект
  category: "Прочие доходы",
  amount: 50000,
  date: new Date('2026-01-20'),
  comment: "Доход от консультационных услуг (Главный офис)"
};
```

### Пример 3: Добавление нового филиала

```typescript
// Администратор добавляет филиал
const response = await fetch('/api/internalObjects/branches', {
  method: 'POST',
  body: JSON.stringify({
    branchName: "Филиал в Казани"
  })
});

const result = await response.json();
console.log(result.branchId); // -3 (новый ID филиала)
```

## Миграция существующих данных

Если в системе уже есть расходы/доходы, привязанные к объектам Beds24, миграция не требуется. Внутренние объекты — это дополнительная функциональность, которая не влияет на существующие данные.

## Резервное копирование

При резервном копировании базы данных убедитесь, что включена коллекция `internalObjects`:

```bash
mongodump --db=your_database --collection=internalObjects
```

## Переменные окружения

### COMPANY_NAME

Название объекта "HolyCowPhuket внутренний объект" (по умолчанию: "HolyCowPhuket внутренний объект").

```env
COMPANY_NAME=HolyCowPhuket внутренний объект
```

## Troubleshooting

### Объект "HolyCowPhuket внутренний объект" не отображается в списке

1. Проверьте, была ли выполнена инициализация:
   ```bash
   POST /api/internalObjects/init
   ```

2. Проверьте коллекцию напрямую:
   ```javascript
   db.internalObjects.find({})
   ```

### Ошибка при создании расхода с отрицательным ID

Убедитесь, что:
1. Объект с указанным ID существует в `internalObjects`
2. ID передаётся как число, а не строка
3. Пользователь авторизован и имеет права `accountant` или `admin`

### Филиалы не отображаются

Проверьте структуру объекта в базе:
```javascript
db.internalObjects.findOne({ id: -1 })
```

Структура должна содержать `roomTypes[0].units` с массивом филиалов.

## Дальнейшее развитие

Потенциальные улучшения:

1. **UI для управления филиалами** — добавить интерфейс в админ-панель
2. **Множественные компании** — поддержка нескольких виртуальных организаций
3. **Иерархия филиалов** — древовидная структура филиалов
4. **Автоматическая инициализация** — при первом входе администратора
5. **Импорт/экспорт филиалов** — массовое управление через CSV/JSON
